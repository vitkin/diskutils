#!/bin/bash
#
# confinedrv v1.1
# (c) copyright by Elmar Stellnberger 2009, Jan 2010
#
#  further information: www.elstel.org/com; look here for an actual contact address
#  current email: estellnb@elstel.org; additional email estellnb@gmail.com
#
# v 1.1: added license (30.10.2013)
#  * better option parsing; some minor fixes
#  * reads page size by getconf
#
# v.1.0: originally published version (Jan 2010)
#  * original authors: Elmar Stellnberger
#

license() {
  cat <<EOQ
CONVERTIBLE FREE SOFTWARE LICENSE
	Version 1.0, 2016-08-10
copyright 2016, by Elmar Stellnberger
Everyone is permitted to copy and distribute verbatim copies of this license document. You must not modify the license itself.
This license applies to any software containing a notice by the copyright holder saying that it may be used under the terms of the Convertible Free Software License. If a specific version number is mentioned then usage rights include this version as well as any newer version which will always be similar in spirit to this license. The term Convertible Free Software license may be abbreviated as C-FSL.

1. Any work under this license comes completely without any warranty or any kind of liability such as lost revenues, profits, harm or damage of any kind even if the authors should have been advised of the possibility of such harm or damage. It may be seen as research work and does not claim for fitness to any particular usage purpose.

2. The term 'source code' applies to the preferred form that is used to develop or apply changes to a work under this license referred to herein as 'the work'. You are allowed to modify or change the source code if you accept that the resulting changed work will become subject to this license. As soon as you apply any change this is an implicit consent to fully comply with this license and a consent that the work may be used under this license. 

3. It is your obligation that the changed version of your sources will be available to the public for free within the time frame of a month at least if there is no undue hindrance by the authors to make it available. Modifications which result in a broken or unusable program which the authors do not plan to continue their work on are considered dead end and do not need to be published. Available for free means that there will be no undue hindrance in obtaining the given item like a registration of the person who wants to download or obtain the given item. Available for free also means that you must not charge for the given item itself apart from the possibility to require a reasonable charge for the physical reproduction of the data.

4. You are allowed to issue an 'automatic derivation process' on the source code which will result in so called 'object code'. You are obligated to provide sufficient data, tools and utilities so that a functionally equivalent object code can be compiled merely from programs and work licensed either under any open source license approved by opensource.org or under C-FSL. The given data and utilities for obtaining functionally equivalent results need to be available to the public for free.

5. When applying changes to the source code you need to leave your name, your email address and the date of your modifications so that other people may contact you. If a contributor should not have a steady access to the internet or a satisfying access to an emailing service he may leave another way by which he can be contacted. We suggest to list all changes by contributors either in a separate changelog file or in the header of the changed file. Several consecutive changes may be collapsed. Furthermore you need to give your changed version a 'marker' which may be used to distinguish it from the upstream version when being distributed to other people. The distributed product needs to be of the form upstream name - dash upstream version - dash your marker optionally followed by a version number under your control. If there should be a chain of upstream contributors there only needs to be one marker by the party which is at the end of the chain as long as that chain remains to be documented in some place where it is shipped with your software. The marker needs to be unique, at least two letters in size. We suggest it to reflect the name of your company or distribution.

6. You may choose to create a fork of a work under C-FSL by giving it a completely different name. However you need to assert that people will know that your fork is based on the original work. If your program has a graphical user interface the whole C-FSL license must be referenced via the GUI. Otherwise a plain text copy of this license needs to be given and packed alongside the distributed product. A complete reference to the base product including email address and web presence must be referenced via the GUI for any GUI program that is a fork of another C-FSL program. If your program has a comprehensive help, manual or info page and is a fork a similar reference to the base product must be given there. It does not apply to quick or short command line help output as long as a more comprehensive help page is also available. Any program under C-FSL which is a fork of another C-FSL program must ship with a reference to the base product. 

7. Contributing to a work under C-FSL means that you will give a group called the 'original authors' a consensus based right to re-license your derived work so that it will be available under both licenses: the C-FSL and the newly applied license. In order to re-license consensus is only required between these original authors. The original authors are the group of people who have initially started to create a work. They shall be mentioned at the beginning of the changelog or the file header of changes. As soon as there is a consensus to do so by all original authors the work may either be re-licensed, published as upstream version without a marker or new people may be accepted and mentioned as 'original authors'. 

8. No work under C-FSL shall be deemed part of an effective measure under anti-circumvention laws like under article 11 of the WIPO copyright treaty adopted on 1996-12-20 or any similar law. By your consent to work under this license you waive any legal power to forbid such circumventions regarding the work under C-FSL or any work combined with it. You must assert that the right to use, modify, generate object code and distribute any software under C-FSL will not be infringed by patent claims or similar law. If you modify a work under C-FSL so that it will knowingly rely on a patent license then it means that you will thereby grant to extend the patent license to any recipient of the work. Every contributor grants by the act of contributing to a work under C-FSL a non-exclusive, worldwide and royalty-free patent license to any prospective contributor or user of the given work applicable to all his 'essential patent claims'. The essential patent claims comprise all claims owned or controlled by the contributor.

9. A work under C-FSL which has another component or plug-in as well as a work under C-FSL which is used itself as a component, plug-in, add-on of another product, any product under C-FSL which is combined or which links against another work requires that the other work will either be put under an open source license as approved by opensource.org or it needs to be put under C-FSL as well. Usage of proprietary libraries and kernel modules pose an exception to this rule. There must be a functionally equivalent open source library for any proprietary library so that a work under C-FSL can run and execute even without any proprietary library. No such restriction applies to kernel modules. The term 'kernel' refers to the core of an operating system. Libraries are separate components which link against the given work or other components. The term 'linking' refers to the relocation of references or addresses when the library is combined with another component in order to make the combined aggregate executable or runnable. Such references are bound to symbols which are part of the common interface between the library and the component which the library is combined with at runtime. Libraries which provide operating system services use a well defined binary interface but do not 'link' against the kernel.

10. This license is either governed by the Laws of Austria or by the laws of the country where the first mentioned original author lives or is a resident. Disputes shall be settled by the nearest proper court given the home town or location of the first original author unless there is a common consensus for another place of court by all original authors. If any of the terms stated in this license were not in accordance with the law of the country that governs this license all other parts of the license shall remain valid.

EOQ
  exit 0;
}

rot=$'\e[1;31m'; drot=$'\e[0;31m'; blau=$'\e[1;34m'; nv=$'\e[0m'; ul=$'\e[4m';
err() { echo -e "${rot}$@${nv}" >&2; }
warn() { echo -e "${drot}$@${nv}" >&2; }
msg() { echo -e "${blau}$@${nv}" >&2; }

ein() { local tok="$1";
  while [ $# -gt 1 ]; do [[ "$tok" = "$2" ]] && return 0; shift; done
  return 1;
}

droploop() {
 local dest loop err=false
 while read dest loop; do 
    #echo losetup -d $loop;
    losetup -d $loop || err=true;
  done < <( grep "^$1 " /dev/shm/confinedrv-loops;)
  $err && return 1
  cp /dev/shm/confinedrv-loops /dev/shm/confinedrv-loops.tmp
  grep -v "^$1 " </dev/shm/confinedrv-loops.tmp >/dev/shm/confinedrv-loops
  rm -f /dev/shm/confinedrv-loops.tmp
}

verbose=1; readall=false; ret=0;

if [[ $# -le 0 ]]; then
  echo -e "$(basename "$0") --help/--license\n"
fi

PAGE_SIZE=$(getconf PAGE_SIZE)
[[ PAGE_SIZE -eq 0 ]] && { warn "assuming page size of 4096."; PAGE_SIZE=4096; }
[[ PAGE_SIZE/512*512 -ne PAGE_SIZE ]] && { err "page size not divisable by 512; exiting."; exit 222; }
let PGspare=PAGE_SIZE/512-1

while [[ $# -gt 0 ]]; do
case "$1" in
  -h|--help) echo -e "confinedrv [--ra] sdx=sda1,2,3,4 sdy=sdb1,2,3,4"
             echo -e "  --ra ... everything at least readable"
	     echo -e "confinedrv -d/-r/--remove sdx sdy ...";
	     echo -e "confinedrv -i/--info sdx sdy ..."
	     echo -e "           -v/--verbose/-q/--quiet: show mapping table / do not show alignement warnings\n"
	     ;;
  -d|-r|--remove) while [ -n "$2" ]; do
		    drv="${2#/dev/mapper/}"
		    dmsetup remove "$drv"
		    droploop "$drv"; let ret+=$?
		    shift
		  done; exit $ret;;
  -i|--info) while [ -n "$2" ]; do
	       echo "*** $2 ***"
	       dmsetup status $2; echo; shift;
	     done;;
  --ra) readall=true; shift; continue; ;;
  -v|--verbose) let verbose++; shift; continue; ;;
  -q|--quiet) let verbose--; shift; continue; ;;
  --license) license;;
  *)

[[ $(id -u) -ne 0 ]] && { err "confinedrv must be run as root.";echo; exit 200; }

read dest org <<<"${1/=/ }"
read -a parts <<<"${org//,/ }"
org=${parts[0]%%[0-9]*}
parts[0]=${parts[0]#$org}; [[ -z "${parts[0]}" ]] && parts=();
#parts=($(sort -g <<<"${parts[@]}";))

# echo $dest#$org#${#parts[@]}
# echo ${parts[@]}
# echo ----------
# exit

getdevno() {
  local attr x usr grp major minor rest
  read attr x usr grp major minor rest < <(ls -l "$1";)
  echo "${major%,}:$minor"
}


mkdir -p /dev/shm/
#bdev=$(getdevno /dev/$org)
if [[ ${#parts[@]} -gt 0 ]]; then
  loop=$(losetup -f)
  losetup $loop /dev/$org
else loop="";
fi

rolp=$(losetup -f)
losetup -r $rolp /dev/$org
blockdev --setro $rolp
chmod gua-w $rolp >/dev/null 2>&1 

#echo "$dest $loop" >>/dev/shm/confinedrv-loops
# -> later
# fdisk -l reads block at 6422432/512 = 12543
# part of sda1!

# device mapper can only control access in chunks of pagesize = 4096 = 2**3*512

alignstart() { let prevstart=start;
  algnstart=$((start&~$PGspare))
  if [[ pos -gt algnstart ]]; then let start=pos; # ok since space before already accessible
                              else let start=algnstart; fi
  #impossible: [[ pos -gt start ]] && { err "inconsistent input from fdisk; disks not ordered."; break; }
  [[ verbose -ge 1 ]]&&[[ algnstart -ne start ]] && warn "aligned partition start from $prevstart to $start"
}

alignend() { let prevend=end;
  algnend=$((end&~$PGspare))
  if [[ pos -gt algnend ]]; then let end=pos; # ok since space before already accessible
                            else let end=algnend; fi
  #impossible: [[ pos -gt end ]] && { err "inconsistent input from fdisk; zero/minus space partition"; break; }
  [[ verbose -ge 1 ]]&&[[ algnend -ne end ]] && warn "aligned partition end from $prevend to $end"
}

skip() {
  if [[ pos -lt $1 ]]; then
    if $extphead||$readall; 
      then echo "$pos $(($1-pos)) linear $rolp $pos";
      else echo "$pos $(($1-pos)) error"
    fi
  fi
}

cleanup() {
  sleep 0.3; rm "$drvtable"; [[ -n "$rolp" ]] && losetup -d $rolp; [[ -n "$loop" ]] && losetup -d $loop
}

drvtable="$(mktemp)"; trap "cleanup" EXIT
pos=0; found=0; extphead=false; extpend=-1; maxdno=0;  #max=0;
{
while read dev start end blocks id type; do
  dno="${dev#/dev/$org}";
  if [ "$dev" != "$dno" ]; then 
    [[ dno -gt maxdno ]] && let maxdno=dno
    if [[ pos -eq 0 ]]; then
      echo "0 $start linear $rolp 0"
      pos=$start;
    fi
    #echo "$dev $pos $start" >&2
    if ein $dno "${parts[@]}"; then
      alignstart
      skip $start
      echo "$start $((end-start+1)) linear $loop $start"
      # not with alignment: echo "$start $((end+1-start)) linear /dev/$org$dno 0"
      # if not aligned then dmsetup will extend attributes towards the end of partition
      [[ extpend -le end ]] && extphead=false
      pos=$((end+1)); let found++;
      
    elif [ "${type#*Erw}" != "$type" -o "${type#*Ext}" != "$type"  ]; then
      alignstart
      skip $start
      extphead=true; extpend=$end
      pos=$start
      
    elif $extphead; then
      let start+=$PGspare # aufrunden ! - extended partition head needs to be fully readable; danach kommt ausgeblendete Partition!
      alignstart
      skip $start
      pos=$start
      
      let end+=1;  # Anfang nächster: end + 1
      extphead=false; # skip soll hier ausblenden (außer -a)
      alignend;      # Platz für den Beginn der nächsten schaffen: nach vorne
      skip $((end))  # skip bearbeitet bis eins vorher
      extphead=true
      [[ extpend -le end ]] && extphead=false
      pos=$((end))
      
    #else echo "unprocessed: $dev" >&2;
    fi
    #[[ max -lt end ]] && let max=end
    #[[ min -gt start ]] && let min=start
  fi
done < <( fdisk -lu -b 512 /dev/$org | tr '*' ' ' | sort -g -k 2 -s; ) 
max=$(blockdev --getsz /dev/$org)
skip $max
} >"$drvtable"

if [[ maxdno -ge 5 ]]&&[[ extpend -lt 0 ]]; then
  err "extended partitions found but no partition called '...Erw' or '...Ext' listed by fdisk -lu";
  echo "you may wish to correct the matching for the name of the exteneded partition in the sources" >&2;
  err "mapping will not function for extended partition"
  echo >&2;
fi

if [[ verbose -gt 1 ]]; then
  msg "hdd mapping table:"
  cat "$drvtable"
  echo
fi

if [ "$found" -ne "${#parts[@]}" ]; then
  err "overlapping partitions specified or";  # can detect this only in cases where partitions become fully overlapped
  err "no such partition on disk."
  msg "$found out of ${#parts[@]} partitions processed.\n"
  cat "$drvtable"
  cleanup
  trap '' EXIT
  ret=207
  
else
 if [ -b /dev/mapper/$dest ]; then 
   echo dmsetup reload $dest \<"$drvtable"
   #dmsetup reload $dest <"$drvtable";
   dmsetup remove $dest
   droploop "$dest";
   dmsetup create $dest <"$drvtable";
 else 
   echo dmsetup create $dest \<"$drvtable"
   dmsetup create $dest <"$drvtable";
 fi
 ret=$?
 #if [ $? -eq 0 ]; then rm "$drvtable"; else echo "please remove $drvtable manually!"; fi
 if [ $ret -ne 0 ]; then
   cleanup
 else
   rm "$drvtable"
   [ -n "$loop" ] && echo "$dest $loop" >>/dev/shm/confinedrv-loops
   echo "$dest $rolp" >>/dev/shm/confinedrv-loops
 fi
 trap '' EXIT
 echo
 
fi
[[ ret -gt 0 ]] && exit $ret

;;
esac;
shift;
done
